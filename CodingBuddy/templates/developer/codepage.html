{% extends 'base.html' %}

{% block title %}Home | Coding Problems{% endblock %}

{% block extra_styles %}
    {{ block.super }}
    <style>
        .container {
            text-align: center;
        }
        .toggle-card, .code-problem, .card {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
            width: 100%;
            position: relative;
            overflow: hidden;
            max-width: 100%;
        }
        .toggle-card {
        box-sizing: border-box;
        min-height: 208px;
        }
        .code-block {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 100px;
            position: relative;
            transition: all 0.3s ease-in-out;
            width: 100%;
        }
        .code-block.expanded {
            max-height: none;
            width: auto;
        }
        .card.expanded {
            max-width: none;
        }
        .show-more {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            display: block;
            width: 100px;
            text-align: center;
            margin: 0 auto;
        }
        .show-more:hover {
            background-color: #0056b3;
        }
        .back-button, .edit-button, .delete-button {
            margin-top: 10px;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
        }
        .back-button {
            background-color: #ccc;
            color: #333;
        }
        .back-button:hover {
            background-color: #bbb;
        }
        .edit-button {
            background-color: #007bff;
            color: #fff;
            margin-left: 10px;
        }
        .edit-button:hover {
            background-color: #0056b3;
        }
        .delete-button {
            background-color: #dc3545;
            color: #fff;
            margin-left: 10px;
        }
        .delete-button:hover {
            background-color: #c82333;
        }
        .row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-right: -15px;
            margin-left: -15px;
        }
        .col-md-4 {
            flex: 0 0 33.33333%;
            max-width: 33.33333%;
            padding-right: 15px;
            padding-left: 15px;
            box-sizing: border-box;
        }
        .comment {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .reply {
            margin-bottom: 5px;
            padding: 8px;
            background-color: #f1f1f1;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .comment-actions {
            margin-top: 10px;
        }
        .reply-input {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .toggle-card-body{
        display: none;
        }

        /* Style for the h2 element */
h2 {
    font-size: 2em; /* Adjust the size as needed */
    font-weight: bold; /* Makes the text bold */
    color: #333; /* Dark gray color for the text */
    margin: 0 0 1em 0; /* Adds margin at the bottom */
    padding: 0; /* Removes default padding */
    text-align: center; /* Center the title */
}

/* Remove underline and default link styling for the a tag within h2 */
h2 a {
    text-decoration: none; /* Removes underline */
    color: inherit; /* Inherits color from the h2 element */
    font-weight: inherit; /* Inherits font weight from the h2 element */
}

/* Additional fancy style for the h2 */
h2 {
    border-bottom: 2px solid #ddd; /* Adds a subtle border at the bottom */
    padding-bottom: 0.5em; /* Adds space between text and border */
    letter-spacing: 1px; /* Adds spacing between letters */
}
        h2 a:hover{
            color: blue;
        }

    </style>
{% endblock %}

{% block content %}
    <div class="container">
        {% if is_developer or is_staff %}
                {% if is_developer %}
                     <h1>DEVELOPER ACCESS</h1>
                {% endif %}
                {% if is_staff %}
                     <h1>ADMIN ACCESS</h1>
                {% endif %}


            <a class="btn btn-primary btn-lg mb-4" href="{% url 'CBapp:add_code_problem' %}" role="button">Add Code Problem</a>

            {% if code_problems %}
                <div class="row">
                    {% for problem in code_problems %}
                       <div class="col-md-4">
                        <div class="toggle-card">
                         <h2><a href="{% url 'CBapp:problem_detail' problem.id %}">{{ problem.problem }}</a></h2>
                            <div class="code-problem toggle-card-body">
                                <div class="code-block" id="description-{{ problem.id }}">
                                    {{ problem.description|safe }}
                                </div>
                                <button class="show-more" onclick="toggleShowMore('description-{{ problem.id }}', this)">Show more</button>
                                <div class="code-block" id="solution-{{ problem.id }}">
                                    {{ problem.solution|safe }}
                                </div>
                                <button class="show-more" onclick="toggleShowMore('solution-{{ problem.id }}', this)">Show more</button>
                                <button onclick="window.location.href='{% url 'CBapp:edit_solution' problem.id %}'" class="edit-button">Edit Solution</button>
                                <button onclick="deleteProblem('{{ problem.id }}')" class="delete-button">Delete</button>

                                <!-- Display comments -->
                                <div class="comments">
                                    <h3>Comments</h3>
                                    {% for comment in problem.comments.all %}
                                        <div class="comment">
                                            <strong>{{ comment.user.username }}</strong>: {{ comment.content }}
                                            <p><em>{{ comment.created_at }}</em></p>
                                            {% if request.user == comment.user and is_developer %}
                                                <button onclick="showEditForm({{ comment.id }})" class="edit-button">Edit</button>

                                                <!-- Edit form (initially hidden) -->
                                                <form id="edit-form-{{ comment.id }}" method="post" action="{% url 'CBapp:edit_comment' comment.id %}" style="display:none;">
                                                    {% csrf_token %}
                                                    <textarea name="content" class="form-control">{{ comment.content }}</textarea>
                                                    <button type="submit" class="btn btn-primary">Update Comment</button>
                                                </form>
                                            {% endif %}

                                            {% if request.user == comment.user and is_staff %}
                                                <!-- Edit and Delete buttons for admin only -->
                                                <div class="comment-actions">
                                                    <button onclick="showEditForm({{ comment.id }})" class="edit-button">Edit</button>
                                                    <form id="edit-form-{{ comment.id }}" method="post" action="{% url 'CBapp:edit_comment' comment.id %}" style="display:none;">
                                                        {% csrf_token %}
                                                        <textarea name="content" class="form-control">{{ comment.content }}</textarea>
                                                        <button type="submit" class="btn btn-primary">Update Comment</button>
                                                    </form>
                                                </div>
                                            {% endif %}

                                            {% if request.user.is_staff %}
                                                <!-- Delete button for admin only -->
                                                <button onclick="deleteComment('{{ comment.id }}')" class="delete-button">Delete</button>
                                            {% endif %}

                                            {% if request.user == comment.user and is_developer %}
                                                <button onclick="deleteComment('{{ comment.id }}')" class="delete-button">Delete</button>
                                            {% endif %}

                                            <!-- Display replies -->
                                            {% if comment.replies.all %}
                                                <div class="replies" style="margin-left: 20px;">
                                                    {% for reply in comment.replies.all %}
                                                        <div class="reply">
                                                            <strong>{{ reply.user.username }}</strong>: {{ reply.content }}
                                                            <p><em>{{ reply.created_at }}</em></p>
                                                            {% if user == reply.user %}
                                                                <form action="{% url 'CBapp:delete_reply' reply.id %}" method="post" style="display:inline;">
                                                                    {% csrf_token %}
                                                                    <button type="submit" class="delete-button">Delete Reply</button>
                                                                </form>
                                                            {% endif %}
                                                        </div>
                                                    {% empty %}
                                                        <p>No replies yet.</p>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <p>No replies yet.</p>
                                            {% endif %}

                                            {% if user.is_staff %}
                                                <!-- Reply input for admin only -->
                                                <form action="{% url 'CBapp:add_comment_reply' comment.id %}" method="post" class="reply-input">
                                                    {% csrf_token %}
                                                    <textarea name="content" placeholder="Reply..." rows="2" class="form-control"></textarea>
                                                    <button type="submit" class="btn btn-secondary">Reply</button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>

                                <!-- Add new comment -->
                                <form method="post" action="{% url 'CBapp:codepage' %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="problem_id" value="{{ problem.id }}">
                                    <textarea name="content" class="form-control" rows="3"></textarea>
                                    <button type="submit" class="btn btn-secondary">Add Comment</button>
                                </form>
                            </div>
                            <button onclick="toggleCard(event)" class="btn btn-primary">Show more</button>
                        </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>No code problems found.</p>
            {% endif %}
            <button onclick="location.href='/'" class="back-button">Back</button>
        {% elif is_student %}
            <h1 class="mb-4">Code Problems</h1>
            <a class="btn btn-primary btn-lg mb-4" href="{% url 'CBapp:student_tutorials' %}" role="button">View Tutorials</a>
            <form method="get" class="mb-4">
                <div class="form-group">
                    <label for="language">Filter by Language:</label>
                    <input type="text" id="language" name="language" value="{{ form.language.value }}" class="form-control">
                </div>
                <button type="submit" class="btn btn-primary">Filter</button>
            </form>
            <div class="row">
                {% if accepted_problems %}
                    {% for problem in accepted_problems %}
                        <div class="col-md-4">
                            <div class="card toggle-card">
                               <h2><a href="{% url 'CBapp:problem_detail' problem.id %}">{{ problem.problem }}</a></h2>

                                <div class="card-body toggle-card-body">
                                    <div class="code-block" id="description-{{ problem.id }}">
                                        {{ problem.description|safe }}
                                    </div>
                                    <button class="show-more" onclick="toggleShowMore('description-{{ problem.id }}', this)">Show more</button>
                                    <div class="code-block" id="solution-{{ problem.id }}">
                                        {{ problem.solution|safe }}
                                    </div>
                                    <button class="show-more" onclick="toggleShowMore('solution-{{ problem.id }}', this)">Show more</button>
                                    <p><strong>Language:</strong> {{ problem.language }}</p>

                                    <!-- Display comments -->
                                    <div class="comments">
                                        <h3>Comments</h3>
                                        {% for comment in problem.comments.all %}
                                            <div class="comment">
                                                <strong>{{ comment.user.username }}</strong>: {{ comment.content }}
                                                <p><em>{{ comment.created_at }}</em></p>
                                                {% if comment.user == request.user %}
                                                    <button onclick="showEditForm({{ comment.id }})" class="edit-button">Edit</button>
                                                    <!-- Edit comment form (initially hidden) -->
                                                    <form id="edit-form-{{ comment.id }}" method="post" action="{% url 'CBapp:edit_comment' comment.id %}" style="display:none;">
                                                        {% csrf_token %}
                                                        <textarea name="content" class="form-control">{{ comment.content }}</textarea>
                                                        <button type="submit" class="btn btn-primary">Update Comment</button>
                                                    </form>
                                                    <button onclick="deleteComment('{{ comment.id }}')" class="delete-button">Delete</button>
                                                {% endif %}
                                                <!-- Display replies -->
                                                {% if comment.replies.all %}
                                                    <div class="replies" style="margin-left: 20px;">
                                                        {% for reply in comment.replies.all %}
                                                            <div class="reply">
                                                                <strong>{{ reply.user.username }}</strong>: {{ reply.content }}
                                                                <p><em>{{ reply.created_at }}</em></p>
                                                                {% if user == reply.user %}
                                                                    <form action="{% url 'CBapp:delete_reply' reply.id %}" method="post" style="display:inline;">
                                                                        {% csrf_token %}
                                                                        <button type="submit" class="delete-button">Delete Reply</button>
                                                                    </form>
                                                                {% endif %}
                                                            </div>
                                                        {% empty %}
                                                            <p>No replies yet.</p>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <p>No replies yet.</p>
                                                {% endif %}

                                                {% if user.is_staff %}
                                                    <!-- Reply input for admin only -->
                                                    <form action="{% url 'CBapp:add_comment_reply' comment.id %}" method="post" class="reply-input">
                                                        {% csrf_token %}
                                                        <textarea name="content" placeholder="Reply..." rows="2" class="form-control"></textarea>
                                                        <button type="submit" class="btn btn-secondary">Reply</button>
                                                    </form>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>

                                    <!-- Add new comment -->
                                    <form method="post" action="{% url 'CBapp:codepage' %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="problem_id" value="{{ problem.id }}">
                                        <textarea name="content" class="form-control" rows="3"></textarea>
                                        <button type="submit" class="btn btn-secondary">Add Comment</button>
                                    </form>
                                </div>
                                    <button onclick="toggleCard(event)" class="btn btn-primary">Show more</button>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No accepted problems found.</p>
                {% endif %}
            </div>
        {% else %}
            <h1>Unauthorized Access</h1>
            <p>You are not authorized to access this page.</p>
        {% endif %}
    </div>
    <script>
        function toggleShowMore(id, button) {
            var codeBlock = document.getElementById(id);
            var card = codeBlock.closest('.code-problem, .card');

            codeBlock.classList.toggle('expanded');
            card.classList.toggle('expanded');

            if (codeBlock.classList.contains('expanded')) {
                button.textContent = 'Show less';
            } else {
                button.textContent = 'Show more';
            }
        }

        function deleteProblem(problemId) {
            if (confirm("Are you sure you want to delete this problem?")) {
                fetch(`/delete_problem/${problemId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert("Error deleting problem");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("Error deleting problem");
                });
            }
        }

        function deleteComment(commentId) {
            if (confirm("Are you sure you want to delete this comment?")) {
                fetch(`/delete_comment/${commentId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert("Error deleting comment");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("Error deleting comment");
                });
            }
        }

        function showEditForm(commentId) {
            var form = document.getElementById('edit-form-' + commentId);
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        function toggleCard(e) {
    const clickedElement = e.target;

    const card = clickedElement.closest('.toggle-card');

    const cardBody = card.querySelector('.toggle-card-body');

    if (cardBody.style.display === 'none' || cardBody.style.display === '') {
        cardBody.style.display = 'block';
        clickedElement.textContent = 'Show less';

    } else {
        cardBody.style.display = 'none';
        clickedElement.textContent = 'Show more';

    }
}


    </script>
{% endblock %}